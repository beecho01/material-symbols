name: Auto-update Material Symbols Icons

on:
  schedule:
    # Check for updates daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    # Allow manual triggering
  
jobs:
  check-and-update-icons:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests
    
    - name: Check for iconify updates
      id: check-updates
      run: |
        echo "Checking for iconify Material Symbols updates..."
        
        # Get current commit hash of iconify material-symbols.json
        CURRENT_HASH=$(curl -s "https://api.github.com/repos/iconify/icon-sets/commits?path=json/material-symbols.json&per_page=1" | jq -r '.[0].sha')
        echo "Current iconify commit: $CURRENT_HASH"
        
        # Check if we have a stored hash
        if [ -f ".github/iconify-hash.txt" ]; then
          STORED_HASH=$(cat .github/iconify-hash.txt)
          echo "Stored hash: $STORED_HASH"
        else
          echo "No stored hash found - first run"
          STORED_HASH=""
        fi
        
        # Compare hashes
        if [ "$CURRENT_HASH" != "$STORED_HASH" ]; then
          echo "ğŸ“¦ New iconify update detected!"
          echo "update_needed=true" >> $GITHUB_OUTPUT
          echo "new_hash=$CURRENT_HASH" >> $GITHUB_OUTPUT
          
          # Store the new hash
          mkdir -p .github
          echo "$CURRENT_HASH" > .github/iconify-hash.txt
        else
          echo "âœ… No updates needed"
          echo "update_needed=false" >> $GITHUB_OUTPUT
        fi
    
    - name: Generate updated icons
      if: steps.check-updates.outputs.update_needed == 'true'
      run: |
        echo "ğŸ¨ Generating updated Material Symbols icons..."
        cd custom_components/material_symbols/data
        python generate_svgs.py
        cd ../../..
    
    - name: Commit and push changes
      if: steps.check-updates.outputs.update_needed == 'true'
      run: |
        # Configure git
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
        
        # Add all changes
        git add .
        
        # Check if there are changes to commit
        if git diff --staged --quiet; then
          echo "â„¹ï¸ No changes to commit"
        else
          # Generate version for commit message
          VERSION=$(date +"%Y.%m.%d")
          ICONIFY_HASH="${{ steps.check-updates.outputs.new_hash }}"
          SHORT_HASH=${ICONIFY_HASH:0:8}
          
          git commit -m "ğŸ¤– Auto-update Material Symbols icons (v$VERSION)" -m "Updated from iconify/icon-sets@$SHORT_HASH" -m "Generated fresh SVG files and JSON files for all icon variants" -m "Updated icon count in README.md" -m "Auto-updated JavaScript and manifest versions"
          
          git push
          
          echo "ğŸš€ Successfully pushed icon updates!"
          echo "ğŸ“Š Version: $VERSION"
          echo "ğŸ”— Iconify commit: $SHORT_HASH"
        fi
