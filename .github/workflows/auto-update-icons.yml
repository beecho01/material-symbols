name: Auto-update Material Symbols Icons

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: icon-auto-update
  cancel-in-progress: false

jobs:
  check-and-update-icons:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true
          token: ${{ github.token }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install OS + Python deps
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          python -m pip install --upgrade pip
          pip install requests

      - name: Check for iconify updates
        id: check-updates
        shell: bash
        run: |
          echo "Checking for iconify Material Symbols updates..."

          API_URL="https://api.github.com/repos/iconify/icon-sets/commits?path=json/material-symbols.json&per_page=1"
          CURRENT_HASH=$(curl -sS "$API_URL" | jq -r '.[0].sha // empty')

          if [ -z "$CURRENT_HASH" ]; then
            echo "‚ùå Failed to obtain current commit hash from Iconify (API empty/ratelimited)."
            exit 1
          fi

          echo "Current iconify commit: $CURRENT_HASH"

          if [ -f ".github/iconify-hash.txt" ]; then
            STORED_HASH=$(cat .github/iconify-hash.txt)
            echo "Stored hash: $STORED_HASH"
          else
            echo "No stored hash found - first run"
            STORED_HASH=""
          fi

          if [ "$CURRENT_HASH" != "$STORED_HASH" ]; then
            echo "üì¶ New iconify update detected!"
            echo "update_needed=true" >> "$GITHUB_OUTPUT"
            echo "new_hash=$CURRENT_HASH" >> "$GITHUB_OUTPUT"

            mkdir -p .github
            echo "$CURRENT_HASH" > .github/iconify-hash.txt
          else
            echo "‚úÖ No updates needed"
            echo "update_needed=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Generate updated icons
        if: steps.check-updates.outputs.update_needed == 'true'
        run: |
          echo "üé® Generating updated Material Symbols icons..."
          cd custom_components/material_symbols/data
          python generate_svgs.py
          cd ../../..

      - name: Commit and push changes
        if: steps.check-updates.outputs.update_needed == 'true'
        shell: bash
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

          git add .
          if git diff --staged --quiet; then
            echo "‚ÑπÔ∏è No changes to commit"
            exit 0
          fi

          VERSION=$(date +"%Y.%m.%d")
          ICONIFY_HASH="${{ steps.check-updates.outputs.new_hash }}"
          SHORT_HASH=${ICONIFY_HASH:0:8}

          git commit -m "ü§ñ Auto-update Material Symbols icons (v$VERSION)" \
                      -m "Updated from iconify/icon-sets@$SHORT_HASH" \
                      -m "Generated fresh SVG files and JSON files for all icon variants" \
                      -m "Updated icon count in README.md" \
                      -m "Auto-updated JavaScript and manifest versions"

          git push origin "HEAD:refs/heads/${{ github.ref_name }}"
          echo "‚úÖ Changes pushed successfully"